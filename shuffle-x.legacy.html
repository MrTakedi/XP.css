<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shuffle-X - Sign in</title>
    
    <link rel="shortcut icon" href="https://cdn.kawaiicdn.net/apps/unifiedsso/assets/favicon_2.ico" type="image/x-icon">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        html, body {
            height: 100%;
        }
        body {
            background-color: #212529;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-container {
            width: 100%;
            max-width: 400px;
            padding: 15px;
        }
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: background-color 0.2s ease-in-out;
        }
        /* ✨ Full-screen loader overlay */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        /* Brand Colors */
        .btn-kawaiigdn { background-color: #FF69B4; color: white; }
        .btn-kawaiigdn:hover { background-color: #FF85C1; }
        .btn-xbox { background-color: #107C10; color: white; }
        .btn-xbox:hover { background-color: #139213; }
        .btn-discord { background-color: #5865F2; color: white; }
        .btn-discord:hover { background-color: #727df5; }
        .btn-google { background-color: #4285F4; color: white; }
        .btn-google:hover { background-color: #67a0f6; }
        .btn-microsoft { background-color: #00A4EF; color: white; }
        .btn-microsoft:hover { background-color: #23b2f5; }
        .btn-line { background-color: #00C300; color: white; }
        .btn-line:hover { background-color: #00e600; }
        .btn-weibo { background-color: #E6162D; color: white; }
        .btn-weibo:hover { background-color: #ff2a42; }
    </style>
</head>
<body>

<div class="loader-overlay" id="loader" style="display: none;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<main class="form-container">
    <div class="card p-4 shadow-lg" style="background-color: #2B3035;">
        <div class="text-center mb-4">
            <img class="mb-4" src="https://cdn.kawaiicdn.net/cdn/i/png/s_346b79a57743ff0b6aab345aa27072507a1320a9964fab015bea1357c39f8419324457b1e114c60c.png?sz=120" alt="Logo" width="90" height="90">
            <h1 class="h3 mb-3 fw-normal" id="message">Shuffle-X - Sign in</h1>
        </div>

        <div id="login-options">
            <form id="email-form" class="mb-3">
                <div class="form-floating">
                    <input type="email" class="form-control" id="email-input" placeholder="name@example.com" required autofocus>
                    <label for="email-input">Email address</label>
                </div>
                <button class="btn btn-primary w-100 py-2 mt-3" type="submit" id="continue-button">Continue</button>
            </form>

            <button class="btn btn-kawaiigdn w-100 py-2 mb-2 social-btn" id="kawaiigdn-login-button">
                <i class="fa-solid fa-cloud"></i> Login with KawaiiGDN
            </button>
             <button class="btn btn-xbox w-100 py-2 mb-2 social-btn" id="xbox-login-button">
                <i class="fab fa-xbox"></i> Login with Xbox
            </button>
            
            <hr>

            <button class="btn btn-discord w-100 py-2 mb-2 social-btn" data-connection="discord">
                <i class="fab fa-discord"></i> Sign in with Discord
            </button>
            <button class="btn btn-google w-100 py-2 mb-2 social-btn" data-connection="google-oauth2">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <button class="btn btn-microsoft w-100 py-2 mb-2 social-btn" data-connection="windowslive">
                <i class="fab fa-windows"></i> Sign in with Microsoft
            </button>
            <button class="btn btn-line w-100 py-2 mb-2 social-btn" data-connection="line">
                <i class="fab fa-line"></i> Sign in with LINE
            </button>
            <button class="btn btn-weibo w-100 py-2 social-btn" data-connection="weibo">
                <i class="fab fa-weibo"></i> Sign in with Weibo
            </button>
        </div>
        
        <div class="text-center mt-3">
             <a href="#" class="text-muted" id="help-button">Need help?</a>
        </div>
    </div>
</main>

<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="helpModalLabel">Quick Help</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
            <img src="https://cdn.kawaiicdn.net/cdn/i/png/s_b86a1f8b832e84d9ae196a5795351642109ff745ede477503f800f6709cd998261ead041b8e332f3.png" alt="Help Icon" style="width: 80px;">
        </div>
        To sign in to the services, simply type the email address your company or organisation gave you.
        <hr>
        <a href="#" id="sso-domain-link">I don't have a company email...</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ssoModal" tabindex="-1" aria-labelledby="ssoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ssoModalLabel">SSO Domain</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please enter your organization's domain:</p>
        <div class="form-floating">
            <input type="text" class="form-control" id="sso-domain-input" placeholder="example.com">
            <label for="sso-domain-input">Domain</label>
        </div>
        <div class="invalid-feedback" id="sso-error-message"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="sso-submit-button">Continue</button>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script type='text/javascript'>
//<![CDATA[

const config = JSON.parse(decodeURIComponent(escape(window.atob('@@config@@'))));
config.extraParams = config.extraParams || {};
const originalParams = new URLSearchParams(config.extraParams);
originalParams.set('redirect_uri', config.callbackURL);
originalParams.set('client_id', config.clientID);

const App = {
    helpModal: null,
    ssoModal: null,

    init: function() {
        this.helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
        this.ssoModal = new bootstrap.Modal(document.getElementById('ssoModal'));

        $('#email-form').on('submit', (e) => {
            e.preventDefault();
            const email = $('#email-input').val().trim();
            if (this.validateEmail(email)) {
                this.showLoader();
                this.handleDomainCheck(email);
            }
        });

        $('.social-btn').on('click', function(e) {
            e.preventDefault();
            const connection = $(this).data('connection');
            if (connection) App.redirect(connection);
        });

        $('#kawaiigdn-login-button').on('click', () => App.redirect('KawaiiGDN'));
        $('#xbox-login-button').on('click', () => App.redirect('xbox'));
        
        $('#help-button').on('click', (e) => {
            e.preventDefault();
            this.helpModal.show();
        });

        // ✨ Logic for the Help Modal -> SSO Domain Modal flow
        $('#sso-domain-link').on('click', (e) => {
            e.preventDefault();
            this.helpModal.hide();
            this.ssoModal.show();
        });

        $('#sso-submit-button').on('click', () => {
            const domain = $('#sso-domain-input').val().trim();
            const errorDiv = $('#sso-error-message');
            if (!domain) {
                errorDiv.text('You cannot leave this blank!').show();
                return;
            }
            if (domain.includes('@')) {
                errorDiv.text('You have to type a domain, not an email.').show();
                return;
            }
            errorDiv.hide();
            this.ssoModal.hide();
            this.showLoader();
            this.handleDomainCheck(domain);
        });
    },

    validateEmail: (email) => {
        const emailRegex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
        return email && emailRegex.test(email);
    },
    
    showLoader: () => {
        $('#loader').fadeIn(200);
    },

    redirect: function(connection, loginHint = '') {
        this.showLoader(); // Show full-screen loader
        $('#message').text('Redirecting to sign in page...');
        
        const authUrl = new URL(window.location.origin + '/authorize');
        authUrl.search = originalParams.toString();
        authUrl.searchParams.set('connection', connection);
        if (loginHint) {
            authUrl.searchParams.set('login_hint', loginHint);
        }
        
        window.location.href = authUrl.toString();
    },

    handleDomainCheck: function(input) {
        // Can handle either a full email or just a domain name
        const domain = input.includes('@') ? input.split('@')[1] : input;
        
        const domainMap = {
            'kawaii.gdn': 'KawaiiGDN',
            'onxbox.net': 'xbox',
            'versatilenode.com': 'vnode',
            'versatilenode.net': 'vnode',
            'cgnetwork.uk': 'vnode',
            'my.blufort.net': 'vnode'
        };

        const connection = domainMap[domain];

        if (connection) {
            this.redirect(connection, input);
        } else {
            // This case is now for unknown domains entered in the SSO modal
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
            $('#loader').fadeOut(200); // Hide loader if there's an error
        }
    }
};

$(document).ready(() => App.init());

//]]>
</script>

</body>
</html>
